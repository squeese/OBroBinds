  local function write2(src, key, new, ...)
    if type(key) == 'function' then
      local old = src or poolAcquire(nil)
      new = next(old, key, new, ...)
      if old ~= new then
        cleanup(old)
      end
      if type(new) == 'table' then
        for _ in pairs(new) do
          return new
        end
        return cleanup(new)
      end
      return new
    end
    local old = type(src) == 'table' and src[key] or nil
    if select("#", ...) > 0 then
      if old and type(old) ~= 'table' then
        new = write2(nil, new, ...)
      else
        new = write2(old, new, ...)
      end
    elseif old ~= new then
      --assert(type(new) ~= "table", "!!")
      cleanup(old)
    end
    if not src then
      if new then
        src = poolAcquire(nil)
        src[key] = new
      end
      return src
    end
    src[key] = new
    for _ in pairs(src) do
      return src
    end
    return poolRelease(src, nil)
  end
